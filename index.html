<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Colorius â€“ True Cascade (Stable)</title>
<style>
body { margin:0; background:#0b0b0b; color:#eaeaea; font-family:monospace; }
#hud { position:fixed; top:10px; right:12px; font-size:12px; }
#bossBar { height:12px; background:#111; border:1px solid #333; margin-top:4px; }
#bossFill { height:100%; background:#c0392b; transition:width .1s linear; }
#app { padding:12px; padding-top:70px; }
.color { margin-bottom:16px; padding-left:8px; border-left:4px solid #e74c3c; }
.bar { height:10px; background:#111; border:1px solid #333; margin-bottom:4px; }
.fill { height:100%; background:#e74c3c; transition:width .05s linear; }
button.buy {
  width:100%; background:#111; border:1px solid #e74c3c;
  color:#e74c3c; font-size:11px; padding:6px;
}
</style>
</head>
<body>

<div id="hud">
  <div id="money">$10</div>
</div>

<div id="app"></div>

<script>
let money = 10;
let bossMax = 100;
let bossHP = bossMax;

const BASE_SPEED = 0.15;
const COST_GROWTH = 1.6;

// bars[i].value is always in [0, 1)
const state = {
  generators: 0,
  cost: 10,
  bars: [{ value: 0 }]
};

function format(n) {
  if (!isFinite(n)) return "0";
  if (n < 1e6) return Math.floor(n).toLocaleString();
  if (n < 1e9) return (n / 1e6).toFixed(2) + "M";
  return (n / 1e9).toFixed(2) + "B";
}

function buyGen() {
  if (money < state.cost) return;
  money -= state.cost;
  state.generators++;
  state.cost = Math.floor(10 * Math.pow(COST_GROWTH, state.generators));
}

function ensureBar(i) {
  if (!state.bars[i]) state.bars[i] = { value: 0 };
}

function tick(dt) {
  if (state.generators === 0) return;

  // 1) Accumulate ONLY bar 1
  state.bars[0].value += BASE_SPEED * state.generators * dt;

  // 2) Propagate with a HARD CAP per frame (mobile safety)
  let cascades = 0;
  const MAX_CASCADES = 10;

  for (let i = 0; i < state.bars.length && cascades < MAX_CASCADES; i++) {
    if (state.bars[i].value >= 1) {
      const overflow = Math.floor(state.bars[i].value);
      state.bars[i].value -= overflow;

      // Feed next bar exactly 'overflow' times
      ensureBar(i + 1);
      state.bars[i + 1].value += overflow;

      cascades += overflow;

      // DAMAGE ONLY when bar 3 (index 2) completes
      if (i + 1 === 2 && overflow > 0) {
        bossHP -= overflow;
        money += overflow;

        if (bossHP <= 0) {
          bossMax *= 5;
          bossHP = bossMax;
        }
      }
    }
  }
}

function render() {
  document.getElementById("money").textContent = "$" + format(money);
  const app = document.getElementById("app");
  app.innerHTML = "";

  const boss = document.createElement("div");
  boss.innerHTML = `
    BOSS HP ${format(bossHP)} / ${format(bossMax)}
    <div id="bossBar"><div id="bossFill" style="width:${Math.max(0,(bossHP / bossMax) * 100)}%"></div></div>
  `;
  app.appendChild(boss);

  const c = document.createElement("div");
  c.className = "color";
  c.innerHTML = `RED<br>Gen: ${state.generators} | Cost: ${format(state.cost)}`;

  for (let i = state.bars.length - 1; i >= 0; i--) {
    const bar = document.createElement("div");
    bar.className = "bar";
    const fill = document.createElement("div");
    fill.className = "fill";
    fill.style.width = Math.min(state.bars[i].value * 100, 100) + "%";
    bar.appendChild(fill);
    c.appendChild(bar);
  }

  const btn = document.createElement("button");
  btn.className = "buy";
  btn.textContent = "BUY GEN";
  btn.onclick = buyGen;
  c.appendChild(btn);

  app.appendChild(c);
}

let last = performance.now();
function loop(now) {
  const dt = Math.min((now - last) / 1000, 0.1); // clamp dt for safety
  last = now;
  tick(dt);
  render();
  requestAnimationFrame(loop);
}
loop(last);
</script>

</body>
</html>
