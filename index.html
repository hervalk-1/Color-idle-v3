<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Colorius â€“ Infinite Cascade (Final)</title>
<style>
body { margin:0; background:#0b0b0b; color:#eaeaea; font-family:monospace; }
#hud { position:fixed; top:10px; right:12px; font-size:12px; }
#bossBar { height:12px; background:#111; border:1px solid #333; margin-top:4px; }
#bossFill { height:100%; background:#c0392b; transition:width .1s linear; }
#app { padding:12px; padding-top:70px; }
.color { margin-bottom:16px; padding-left:8px; border-left:4px solid #e74c3c; }
.bar { height:10px; background:#111; border:1px solid #333; margin-bottom:4px; }
.fill { height:100%; background:#e74c3c; transition:width .05s linear; }
button.buy {
  width:100%; background:#111; border:1px solid #e74c3c;
  color:#e74c3c; font-size:11px; padding:6px;
}
</style>
</head>
<body>

<div id="hud">
  <div id="money">$10</div>
</div>

<div id="app"></div>

<script>
let money = 10;
let bossMax = 100;
let bossHP = bossMax;

const BASE_SPEED = 0.15;
const COST_GROWTH = 1.6;
const MAX_RENDER_BARS = 6;

const state = {
  generators: 0,
  cost: 10,
  bars: [
    { value: 0, unlocked: true, unlockedNext: false } // Bar 1
  ]
};

function format(n) {
  if (!isFinite(n)) return "0";
  if (n < 1e6) return Math.floor(n).toLocaleString();
  if (n < 1e9) return (n / 1e6).toFixed(2) + "M";
  return (n / 1e9).toFixed(2) + "B";
}

function buyGen() {
  if (money < state.cost) return;
  money -= state.cost;
  state.generators++;
  state.cost = Math.floor(10 * Math.pow(COST_GROWTH, state.generators));
}

function createBar() {
  return { value: 0, unlocked: true, unlockedNext: false };
}

function tick(dt) {
  if (state.generators === 0) return;

  // Bar 1 continuous fill
  state.bars[0].value += BASE_SPEED * state.generators * dt;

  let cascades = 0;
  const MAX_CASCADES = 10;

  for (let i = 0; i < state.bars.length && cascades < MAX_CASCADES; i++) {
    const bar = state.bars[i];
    if (!bar.unlocked) break;

    if (bar.value >= 1) {
      const overflow = Math.floor(bar.value);
      bar.value -= overflow;
      cascades += overflow;

      // Unlock NEXT BAR ONLY ONCE EVER
      if (!bar.unlockedNext) {
        state.bars[i + 1] = createBar();
        bar.unlockedNext = true;
      }

      // Feed next bar if it exists
      if (state.bars[i + 1]) {
        state.bars[i + 1].value += overflow;
      }

      // Damage logic: bar 3+
      if (i + 1 >= 2) {
        const tier = (i + 1) - 2;
        const dmg = overflow * Math.pow(2, tier);
        bossHP -= dmg;
        money += dmg;

        if (bossHP <= 0) {
          bossMax *= 5;
          bossHP = bossMax;
        }
      }
    }
  }
}

function render() {
  document.getElementById("money").textContent = "$" + format(money);
  const app = document.getElementById("app");
  app.innerHTML = "";

  const boss = document.createElement("div");
  boss.innerHTML = `
    BOSS HP ${format(bossHP)} / ${format(bossMax)}
    <div id="bossBar"><div id="bossFill" style="width:${Math.max(0,(bossHP / bossMax) * 100)}%"></div></div>
  `;
  app.appendChild(boss);

  const c = document.createElement("div");
  c.className = "color";
  c.innerHTML = `RED<br>Gen: ${state.generators} | Cost: ${format(state.cost)}`;

  const unlockedBars = state.bars;
  const start = Math.max(0, unlockedBars.length - MAX_RENDER_BARS);

  for (let i = unlockedBars.length - 1; i >= start; i--) {
    const bar = unlockedBars[i];
    const barDiv = document.createElement("div");
    barDiv.className = "bar";
    const fill = document.createElement("div");
    fill.className = "fill";
    fill.style.width = Math.min(bar.value * 100, 100) + "%";
    barDiv.appendChild(fill);
    c.appendChild(barDiv);
  }

  const btn = document.createElement("button");
  btn.className = "buy";
  btn.textContent = "BUY GEN";
  btn.onclick = buyGen;
  c.appendChild(btn);

  app.appendChild(c);
}

let last = performance.now();
function loop(now) {
  const dt = Math.min((now - last) / 1000, 0.1);
  last = now;
  tick(dt);
  render();
  requestAnimationFrame(loop);
}
loop(last);
</script>

</body>
</html>
